// server.js - The Conductor of the AI Pantheon
import express from 'express';
import cors from 'cors';
import 'dotenv/config';
import { generateWithReplicate } from './services/replicateService.js';
import { generateWithOpenAI } from './services/openaiService.js';

const app = express();
const port = process.env.PORT || 3001;

app.use(cors());
app.use(express.json());

// The Unified Generation Endpoint
app.post('/generate', async (req, res) => {
  const { prompt, engine } = req.body;

  if (!prompt || !engine) {
    return res.status(400).json({ error: 'Prompt and engine are required.' });
  }

  console.log(`Generating with ${engine} for prompt: "${prompt}"`);
  let imageUrl;

  try {
    switch (engine) {
      case 'replicate':
        imageUrl = await generateWithReplicate(prompt);
        break;
      case 'openai':
        imageUrl = await generateWithOpenAI(prompt);
        break;
      default:
        return res.status(400).json({ error: 'Invalid engine selected.' });
    }

    res.json({ imageUrl });

  } catch (error) {
    console.error(`Error with ${engine}:`, error);
    res.status(500).json({ error: `Failed to generate image with ${engine}.` });
  }
});

app.listen(port, () => {
  console.log(`AI Pantheon backend listening on port ${port}`);
});
