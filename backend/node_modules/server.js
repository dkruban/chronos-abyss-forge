// server.js - The Core of CHRONOS
import express from 'express';
import cors from 'cors';
import Replicate from 'replicate';
import 'dotenv/config';

const app = express();
const port = process.env.PORT || 3001;

// Middleware
app.use(cors());
app.use(express.json());

// Initialize Replicate with your API token
const replicate = new Replicate({
  auth: process.env.REPLICATE_API_TOKEN,
});

// The "Secret Sauce" - Our Premium Prompt Engineering
const PROMPT_PREFIX = "masterpiece, ultra-premium, photorealistic, insanely detailed, cinematic, dark fantasy, horror, creature design, art by Zdzisław Beksiński and Wayne Barlowe, rendered in Octane, Unreal Engine 5, 8K, ";
const PROMPT_SUFFIX = ", towering biomechanical demon forged in the core of a black hole, its body a living volcano of rage and power, asymmetrical body, obsidian armor with gold inlay, biomechanical chitinous plates, fire is a complex multi-layered effect of blinding white-blue plasma, liquid gold, and magma red, soulfire, epic scale";

// The Generation Endpoint
app.post('/generate', async (req, res) => {
  const { userPrompt } = req.body;

  if (!userPrompt) {
    return res.status(400).json({ error: 'User prompt is required.' });
  }

  // Construct the ultimate prompt
  const finalPrompt = `${PROMPT_PREFIX}${userPrompt}${PROMPT_SUFFIX}`;

  console.log('Generating with prompt:', finalPrompt);

  try {
    const input = {
      prompt: finalPrompt,
      width: 1024,
      height: 1024,
      refine: "expert_ensemble_refiner",
      scheduler: "K_EULER",
      num_outputs: 1,
      guidance_scale: 7.5,
    };
    
    // Using a powerful SDXL model
    const model = "stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b";
    const output = await replicate.run(model, { input });

    const imageUrl = output[0];
    console.log('Generation complete:', imageUrl);
    res.json({ imageUrl });

  } catch (error) {
    console.error('Error generating image:', error);
    res.status(500).json({ error: 'Failed to generate image.' });
  }
});

app.listen(port, () => {
  console.log(`CHRONOS backend listening on port ${port}`);
});
